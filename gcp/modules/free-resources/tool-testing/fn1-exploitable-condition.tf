# False Negative Test 1: Exploitable Condition Constraint
#
# SCENARIO: A service account has setIamPolicy but with a condition that
# appears restrictive but is actually bypassable or irrelevant.
#
# EXPECTED TOOL BEHAVIOR:
#   - Tool SHOULD detect this as a privilege escalation path
#   - The condition doesn't prevent the escalation
#
# WHY IT'S A FALSE NEGATIVE IF MISSED:
#   - Conditions like time-based or request-based conditions may not
#     actually prevent exploitation

resource "google_service_account" "fn1_exploitable_condition" {
  account_id   = "${var.resource_prefix}-fn1-condition"
  display_name = "FN1 - Exploitable Condition"
  description  = "Has setIamPolicy with exploitable condition"
  project      = var.project_id

  depends_on = [time_sleep.tt_batch1_delay]
}

# Custom role with setIamPolicy - should be detected
resource "google_project_iam_custom_role" "fn1_role" {
  role_id     = "${var.resource_prefix}_fn1_role"
  title       = "FN1 - setIamPolicy with Condition"
  description = "Test: setIamPolicy with exploitable condition"
  permissions = [
    "resourcemanager.projects.get",
    "resourcemanager.projects.getIamPolicy",
    "resourcemanager.projects.setIamPolicy",
  ]
  project = var.project_id
}

# Grant with a time-based condition (still exploitable within the time window)
resource "google_project_iam_member" "fn1_role_binding" {
  project = var.project_id
  role    = google_project_iam_custom_role.fn1_role.id
  member  = "serviceAccount:${google_service_account.fn1_exploitable_condition.email}"

  condition {
    title       = "business-hours"
    description = "Only during business hours (but still exploitable during those hours)"
    expression  = "request.time.getHours(\"America/Los_Angeles\") >= 9 && request.time.getHours(\"America/Los_Angeles\") <= 17"
  }
}

# Allow attacker to impersonate
resource "google_service_account_iam_member" "fn1_impersonate" {
  service_account_id = google_service_account.fn1_exploitable_condition.name
  role               = "roles/iam.serviceAccountTokenCreator"
  member             = var.attacker_member
}
